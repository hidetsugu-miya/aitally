## 変更履歴

- v1.0 (2026-02-25): 初版作成
- v1.1 (2026-02-25): Auditorレビューに基づきCS-01~CS-06を修正（読み取り専用表現の修正、ユーザー指定ライブラリの明記、テーブル定義との整合、Minitest移行影響の具体化、開発者視点への統一）
- v1.2 (2026-02-25): ページネーション要件追加（REQ-009）、コーディングルールのaitally向けカスタマイズとレイヤー構造に基づく責務分離の反映、テストカバレッジ対象範囲の明確化

## 背景

- apps/claude-collector がClaude Codeの利用統計データ（セッション情報、モデル別利用量）をPostgreSQLデータベースに収集・蓄積している
- 蓄積されたデータを外部から参照する手段が存在しない
- apps/rails がAPI-onlyモードで稼働しているが、ヘルスチェックのみでデータ提供機能がない
- apps/rails にはマルチデータベース設定とclaude_collectorデータベースに接続するモデル（ClaudeCollector::Session, ClaudeCollector::ModelUsage）が既に存在するが、APIエンドポイントが未実装
- テストフレームワーク、JSONシリアライズ、APIドキュメント生成の仕組みが未導入
- 開発チーム向けのコーディングルールが未整備
- 一覧系APIにおいてデータ量増加時のレスポンス制御手段がない

## 目的

- claude-collectorが収集した利用統計データをAPI経由で参照できるようにする
- テスト基盤を整備し、既存コードを含むアプリケーション全体でコードカバレッジ100%を維持できる体制を構築する
- APIドキュメントを自動生成し、API仕様を常に最新の状態で参照できるようにする
- JSON形式でのレスポンス構造を統一的に管理できるようにする
- aitally プロジェクト向けのコーディングスタンダードを文書化し、レイヤー構造に基づいた責務分離が実現された開発体制を整備する

## スコープ

### 対象範囲

- apps/rails へのテストフレームワークの導入（ユーザー指定: rspec）
- apps/rails へのコードカバレッジ計測ツールの導入（ユーザー指定: simplecov）
- apps/rails へのAPIドキュメント生成ツールの導入（ユーザー指定: rswag）
- apps/rails へのJSONシリアライザの導入（ユーザー指定: alba）
- apps/rails へのページネーション機能の導入（ユーザー指定: kaminari）
- セッション一覧取得APIの実装（ページネーション対応）
- セッション詳細取得APIの実装（関連するモデル別利用量を含む）
- モデル別利用量一覧取得APIの実装（ページネーション対応）
- コーディングルールファイル7種の作成と配置（coding-standards.md, controller.md, model-rules.md, presenter.md, rbs.md, services.md, testing-rules.md）

### 対象外範囲

- claude-collectorのデータ収集処理の変更
- データの作成・更新・削除API（参照専用）
- 認証・認可の実装
- フロントエンドの実装
- apps/rails の primary データベースへの新規テーブル作成

## 要件一覧

| ID | 要件名 | 概要 |
|---|---|---|
| REQ-001 | テストフレームワークの導入 | 開発者が rspec でテストを実行できる |
| REQ-002 | コードカバレッジ計測の導入 | 既存コードを含むアプリケーション全体でカバレッジ100%を維持できる |
| REQ-003 | APIドキュメント生成の導入 | 開発者がテストからOpenAPI仕様のAPIドキュメントを生成・閲覧できる |
| REQ-004 | JSONシリアライザの導入 | 開発者がAPIレスポンスのJSON構造を統一的に定義・管理できる |
| REQ-005 | セッション一覧の参照API | 収集済みセッションデータの一覧をページネーション付きでAPI経由で取得できる |
| REQ-006 | セッション詳細の参照API | 特定セッションの詳細情報をモデル別利用量とともにAPI経由で取得できる |
| REQ-007 | モデル別利用量一覧の参照API | モデル別利用量データの一覧をページネーション付きでAPI経由で取得できる |
| REQ-008 | コーディングルールファイルの導入 | aitally向けの開発ルールを文書化し、レイヤー構造に基づく責務分離のルールを含めてプロジェクト内に配置する |
| REQ-009 | ページネーション機能の導入 | 一覧系APIのレスポンスをページ単位で分割して取得できる |

### REQ-001: テストフレームワークの導入

**概要**: 開発者が apps/rails で rspec を使用してテストを実行できるようにする

**期待される動作**:

- 開発者が rspec コマンドでテストを実行できる
- テスト用のディレクトリ構成（spec/）が整備される
- テストヘルパーが設定され、開発者がRails環境でのテストを記述・実行できる

### REQ-002: コードカバレッジ計測の導入

**概要**: 開発者が apps/rails のテスト実行時にコードカバレッジレポートを確認できるようにする

**期待される動作**:

- 開発者がテスト実行時にコードカバレッジの計測結果を確認できる
- 既存コードを含むアプリケーション全体でカバレッジ100%が維持される
- 開発者がカバレッジレポートを参照して未カバー箇所を特定できる

### REQ-003: APIドキュメント生成の導入

**概要**: 開発者が apps/rails のテストからOpenAPI仕様のAPIドキュメントを生成・閲覧できるようにする

**期待される動作**:

- 開発者がAPIテスト（request spec）からOpenAPI（Swagger）仕様のドキュメントを生成できる
- 開発者が生成されたドキュメントをブラウザで閲覧できる
- 開発者がAPIの追加・変更時にドキュメントを再生成して最新化できる

### REQ-004: JSONシリアライザの導入

**概要**: 開発者が apps/rails のAPIレスポンスのJSON構造を alba で統一的に定義・管理できるようにする

**期待される動作**:

- 開発者がシリアライザを通じてAPIレスポンスのJSON構造を定義・管理できる
- 開発者がAPI全体で統一されたレスポンス形式を維持できる

### REQ-005: セッション一覧の参照API

**概要**: claude-collectorが収集したセッションデータの一覧をJSON形式でページネーション付きで取得できるAPIエンドポイントを提供する

**期待される動作**:

- セッション一覧がJSON形式で取得できる
- セッションに関連する収集済みの全ての情報が含まれる
- 一覧のレスポンスがページ単位で分割して取得できる
- claude_collector データベースからの参照のみのアクセスである

### REQ-006: セッション詳細の参照API

**概要**: 特定のセッションの詳細情報を、関連するモデル別利用量データとともにJSON形式で取得できるAPIエンドポイントを提供する

**期待される動作**:

- セッションIDを指定して詳細情報が取得できる
- セッションに関連するモデル別利用量の一覧が含まれる
- 指定されたセッションが存在しない場合、適切なエラーレスポンスが返される

### REQ-007: モデル別利用量一覧の参照API

**概要**: モデル別利用量データの一覧をJSON形式でページネーション付きで取得できるAPIエンドポイントを提供する

**期待される動作**:

- モデル別利用量の一覧がJSON形式で取得できる
- 各レコードに関連する収集済みの全ての情報が含まれる
- 一覧のレスポンスがページ単位で分割して取得できる
- claude_collector データベースからの参照のみのアクセスである

### REQ-008: コーディングルールファイルの導入

**概要**: aitally プロジェクト向けのコーディングスタンダード・設計ルールを文書化し、レイヤー構造に基づく責務分離のルールを含めてプロジェクトに配置する

**期待される動作**:

- 以下の7つのルールファイルが作成・配置される: coding-standards.md, controller.md, model-rules.md, presenter.md, rbs.md, services.md, testing-rules.md
- 各ファイルが aitally プロジェクトの開発方針に沿ったルールを定義している
- レイヤー構造に基づいた責務分離（各レイヤーの責務範囲と依存方向のルール）が定義されている
- プロジェクト内から参照可能な場所に配置される

### REQ-009: ページネーション機能の導入

**概要**: 一覧系APIのレスポンスをページ単位で分割して取得できるようにする（ユーザー指定: kaminari）

**期待される動作**:

- 一覧系APIでレスポンスがページ単位で分割される
- ページ番号を指定して任意のページのデータを取得できる
- レスポンスにページネーションのメタ情報（総件数、総ページ数、現在のページ番号）が含まれる

## 現状と目標

- **現状（As-Is）**: apps/rails はヘルスチェックのみのAPI-onlyアプリケーション。マルチDB設定とclaude_collectorデータベースに接続するモデルは存在するが、APIエンドポイント・テスト基盤・ドキュメント生成・シリアライザ・ページネーション・コーディングルールが未整備
- **目標（To-Be）**: apps/rails がclaude-collectorの収集データをページネーション対応の参照APIとして提供し、既存コードを含むアプリケーション全体でテストカバレッジ100%・APIドキュメント自動生成・統一的なJSON構造・レイヤー構造に基づく責務分離のルールを含むコーディングルールが整備された状態

## ユーザー期待値（検証は設計フェーズ）

### 外部システム連携の期待

- 該当なし

### 運用要件の期待

- 該当なし

### 非機能要件の期待

- 既存コードを含むアプリケーション全体でテストカバレッジ100%の維持

## 横断的関心事

### セキュリティ要件

- claude_collector データベースへのAPIからのアクセスは参照のみとする（データの作成・更新・削除はAPIから行わない）
- database_tasks: false はマイグレーション管理の無効化であり、データベースレベルの書き込み制限ではないため、アプリケーション層で参照専用を担保する
- 認証・認可は本スコープ対象外（将来的な導入を想定）

### コード品質要件

- 既存コードを含むアプリケーション全体でテストカバレッジ100%を維持する
- RuboCop による静的解析を通過すること（既に導入済み）
- Steep による型チェックを通過すること（既に導入済み）
- Brakeman によるセキュリティスキャンを通過すること（既に導入済み）
- コーディングルールファイル（7種）に準拠した実装を行うこと

### 制約条件

- apps/rails は API-only モード（ActionController::API）で動作する
- claude_collector データベースはAPIからの参照専用とする（マイグレーションは apps/claude-collector が管理、database_tasks: false）
- claude_collector データベースのスキーマは apps/claude-collector が管理しており、apps/rails からは変更しない
- Ruby 4.0.1、Rails 8.1.2 環境
- Docker Compose 上で動作する（サービス名: rails-api）

## 影響範囲

### 依存関係

- REQ-005, REQ-007 は REQ-001（テストフレームワーク）、REQ-003（APIドキュメント生成）、REQ-004（JSONシリアライザ）、REQ-009（ページネーション）に依存する
- REQ-006 は REQ-001（テストフレームワーク）、REQ-003（APIドキュメント生成）、REQ-004（JSONシリアライザ）に依存する
- REQ-002（カバレッジ計測）は REQ-001（テストフレームワーク）に依存する
- REQ-003（APIドキュメント生成）は REQ-001（テストフレームワーク）に依存する
- 既存のマルチDB設定（database.yml）およびclaude_collectorデータベースに接続するモデル（ClaudeCollector::Session, ClaudeCollector::ModelUsage）に依存する
- claude-collector が収集・蓄積するデータのスキーマ（sessions テーブル、model_usages テーブル）に依存する

### 影響を受ける機能

- Gemfile への gem 追加により、既存の bundle 環境が変更される
- テストフレームワーク変更（Minitest から rspec への移行）により、既存の test/ ディレクトリ構成が不要になる。また、application.rb における rails/test_unit/railtie の require 除去が必要になる可能性がある（設計フェーズで判断）
- routes.rb へのエンドポイント追加

## 想定リスク

- claude_collector データベースのスキーマが変更された場合、apps/rails 側のモデル定義と不整合が生じる可能性がある
- rswag 導入により API-only モードで追加の設定（Swagger UI 表示のためのビュー関連設定）が必要になる可能性がある

## その他懸念事項

- コーディングルールファイル7種の具体的な内容・配置場所は設計フェーズで決定する
- 将来的にフィルタリング、ソート機能の追加が想定される
- 将来的に認証・認可の導入が想定される
